#!/bin/sh
set -e

if [ -d .git ] && ! LANG=C git-status 2>&1 | grep -q "working directory clean"; then
	RET="true"
	if [ -e /usr/share/debconf/confmodule ]; then
		. /usr/share/debconf/confmodule
		db_capb escape
		db_title etckeeper

		db_reset etckeeper/unclean || true
		db_subst etckeeper/unclean STATUS $(git status | debconf-escape -e) || true
		db_input critical etckeeper/unclean || true
		db_go || true
		db_get etckeeper/unclean
	fi
	if [ "$RET" = true ]; then
		git add .
		if ! git commit $GIT_COMMIT_OPTIONS -m "saving uncommitted changes in /etc prior to $HIGHLEVEL_PACKAGE_MANAGER run"; then
			if [ -e /usr/share/debconf/confmodule ]; then
				db_input critical etckeeper/commit_failed || true
				db_go || true
				db_reset etckeeper/commit_failed || true
			else
				echo "error: etckeeper failed to commit changes in /etc using git (git commit failed)"
				exit 1
			fi
		fi
	fi
	if [ -e /usr/share/debconf/confmodule ]; then
		db_reset etckeeper/unclean || true
	fi
fi
